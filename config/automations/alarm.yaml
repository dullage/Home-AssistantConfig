# Arm the alarm when we both leave
- alias: alarm_arm_on_leaving
  initial_state: true
  trigger:
    platform: state
    entity_id: group.everyone
  condition:
    condition: template
    value_template: "{{ states('group.everyone') != 'home' }}"
  action:
    service: alarm_control_panel.alarm_arm_away
    entity_id: alarm_control_panel.ha_alarm

# Arm the alarm if HA starts and we're both out.
- alias: alarm_arm_on_startup_if_out
  initial_state: true
  trigger:
    platform: homeassistant
    event: start
  condition:
    condition: template
    value_template: "{{ states('group.everyone') != 'home' }}"
  action:
    service: alarm_control_panel.alarm_arm_away
    entity_id: alarm_control_panel.ha_alarm

# Disarm the alarm when either of us come home
- alias: alarm_disarm_on_arrival
  initial_state: true
  trigger:
    - platform: state
      entity_id: person.adam
      to: "home"
    - platform: state
      entity_id: person.leanne
      to: "home"
  action:
    service: alarm_control_panel.alarm_disarm
    entity_id: alarm_control_panel.ha_alarm

# Disarm the night alarm when there is motion downstairs (excl where the cat can get) after 4am.
- alias: alarm_disarm_on_wake
  initial_state: true
  trigger:
    platform: state
    entity_id:
      - binary_sensor.stairs_motion_sensor_occupancy
      - binary_sensor.dining_room_motion_sensor_occupancy
      - binary_sensor.kitchen_door_sensor_contact
      - binary_sensor.front_door_contact
    to:
      - "on"
      - "off"
  condition:
    condition: and
    conditions:
      - condition: state
        entity_id: alarm_control_panel.ha_alarm
        state: "armed_night"
      - condition: time
        after: "04:00:00"
  action:
    service: alarm_control_panel.alarm_disarm
    entity_id: alarm_control_panel.ha_alarm

# Disarm the alarm if the "Disarm" button is pressed in the iOS notification.
- alias: alarm_disarm
  initial_state: true
  trigger:
    platform: event
    event_type: ios.notification_action_fired
    event_data:
      actionName: DISARM_ALARM
  action:
    - service: alarm_control_panel.alarm_disarm
      entity_id: alarm_control_panel.ha_alarm

# Alarms sensors active only when alarm is in armed_away mode.
- alias: alarm_sensors_away_only
  initial_state: true
  trigger:
    - platform: state
      entity_id:
        # Internal Doors
        - binary_sensor.kitchen_door_sensor_contact
        - binary_sensor.front_room_door_sensor_contact
        - binary_sensor.bathroom_door_sensor_contact
        - binary_sensor.master_bedroom_door_sensor_contact
        - binary_sensor.blues_room_door_sensor_contact
        # Windows
        - binary_sensor.bedroom_window_contact
      to:
        - "on"
        - "off"
  condition:
    condition: state
    entity_id: alarm_control_panel.ha_alarm
    state: "armed_away"
  action:
    service: script.trigger_alarm
    data:
      trigger: "{{ trigger.entity_id }}"

- alias: alarm_sensors_away_only_detections
  trigger:
    platform: event
    event_type: folder_watcher
    event_data:
      event_type: modified
  condition:
    - condition: state
      entity_id: alarm_control_panel.ha_alarm
      state: "armed_away"
    - condition: template
      value_template: "{{ trigger.event.data.file in ['side.jpg', 'garden.jpg'] }}"
  action:
    service: script.trigger_alarm
    data:
      trigger: "{{ trigger.event.data.file }}"

# Alarms sensors active when alarm is in armed_away or armed_night mode.
- alias: alarm_sensors_away_or_night
  initial_state: true
  trigger:
    - platform: state
      entity_id:
        # External Doors
        - binary_sensor.front_door_contact
        - binary_sensor.garden_door_contact
        - binary_sensor.patio_doors_contact
      to:
        - "on"
        - "off"
  condition:
    condition: state
    entity_id: alarm_control_panel.ha_alarm
    state:
      - "armed_away"
      - "armed_night"
  action:
    service: script.trigger_alarm
    data:
      trigger: "{{ trigger.entity_id }}"

# Debug
- alias: alarm_debug_armed_away
  initial_state: true
  trigger:
    platform: state
    entity_id: alarm_control_panel.ha_alarm
    to: "armed_away"
  action:
    service: notify.mobile_app_dullage_s_iphone
    data:
      message: "Alarm Armed (Away)"
- alias: alarm_debug_armed_night
  initial_state: true
  trigger:
    platform: state
    entity_id: alarm_control_panel.ha_alarm
    to: "armed_night"
  action:
    service: notify.mobile_app_dullage_s_iphone
    data:
      message: "Alarm Armed (Night)"
- alias: alarm_debug_disarmed
  initial_state: true
  trigger:
    platform: state
    entity_id: alarm_control_panel.ha_alarm
    to: "disarmed"
  action:
    service: notify.mobile_app_dullage_s_iphone
    data:
      message: "Alarm Disarmed"
